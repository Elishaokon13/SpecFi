version: 2.1
jobs:
    test-and-lint:
      docker: 
        - image: circleci/node:14-bullseye-browsers
      steps:
        - checkout
        - run: 
            name: Run Style linter
            command: yarn lint:stylelint
        - run:
            name: Run Eslint
            command: yarn lint:eslint
        - run: 
            name: Run Tests
            command: yarn test --passWithNoTests
    build-app:
      docker:
        - image: circleci/node:14-bullseye-browsers
      working_directory: /tmp/app/
      steps:
        - checkout
        - run:
            name: Create Artifacts
            environment:
              CI: "false"
            command: yarn && yarn build && printenv
        - store_artifacts:
            path: /tmp/app/build
    deploy-to-dev:
      machine:
        enabled: true
      steps:
        - checkout
        - run:
            name: Deploy
            command: |
                    ${SERVER_CONNECTION_COMMAND} 'cd /var/www/test_tmp/ \
                    curl -H "Circle-Token: ${DEPLOY_TOKEN}" https://circleci.com/api/v1.1/project/github/ergolabs/ergo-dex-frontend/${CIRCLE_BUILD_NUM}/artifacts \
                        | grep -o 'https://[^"]*' \
                        | wget --verbose --header "Circle-Token: 2865382f5c1a1f3e772ccee317246472d5fa4ce1" --input-file -'
    deploy-to-prod:
      machine:
        enabled: true
      steps:
        - checkout
        - run:
            name: Deploy to prod
            command: |
                    ${SERVER_CONNECTION_COMMAND} 'source ~/.nvm/nvm.sh; cd /var/www/app; git pull origin master; yarn; yarn build;'
workflows:
  version: 2
  preparing:
    jobs:
      - test-and-lint:
          pre-steps:
            - checkout
            - run: 
                command: yarn
          filters:
            branches:
              ignore: master
  deployment:
    jobs:
      - build-app:
          filters:
            branches:
              only:
                - cicd-piplines
      - hold:
          type: approval
      - deploy-to-dev:
          requires:
            - build-app
          filters:
            branches:
              only: 
                - dev
                - cicd-piplines
              ignore: master
      - deploy-to-prod:
          requires: 
            - hold
            - build-app
          filters:
            branches:
              only: master
              ignore: dev


    
      
